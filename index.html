<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OD Image Generator</title>
  <style>
    :root{
      --bg:#0f1520; --panel:#121822; --ink:#eee; --muted:#9ecbff; --line:#333; --accent:#1f7bf2; --chip:#1a1f2e;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;background:var(--bg);color:var(--ink)}
    .container{max-width:900px;margin:0 auto;padding:20px}
    h1{margin:0 0 20px;text-align:center}
    h2{font-size:16px;margin:20px 0 8px}
    select, textarea, button{font-size:14px}
    select{width:100%;padding:10px;border-radius:8px;border:1px solid var(--line);background:var(--bg);color:var(--ink)}
    textarea{width:100%;min-height:150px;margin-top:10px;border-radius:8px;border:1px solid var(--line);padding:10px;background:var(--bg);color:var(--ink)}
    button{padding:10px 16px;margin-top:10px;border:none;border-radius:8px;cursor:pointer;background:var(--accent);color:white}
    .prompt-box{margin-top:8px;font-size:13px;color:var(--muted);background:var(--panel);padding:8px;border-radius:6px;white-space:pre-wrap}
    .emotion-grid{display:grid;grid-template-columns:repeat(1,1fr);gap:12px}
    .emotion-btn{padding:8px;border:1px solid #444;border-radius:6px;text-align:center;cursor:pointer;background:var(--chip)}
    .radio-group{margin:12px 0}
    .radio-group__title{display:flex;align-items:center;gap:8px;margin-bottom:6px}
    .chip{display:inline-block;padding:6px 10px;border:1px solid #444;border-radius:999px;background:var(--chip)}
    .radio-group label{display:inline-block;margin:4px;cursor:pointer}
    .radio-group input[type="radio"], .radio-group input[type="checkbox"]{display:none}
    .radio-group span{display:inline-block;padding:8px 14px;border:1px solid #444;border-radius:8px;background:var(--chip);color:var(--ink);transition:.15s;user-select:none}
    .radio-group span:hover{background:#243048;border-color:var(--accent)}
    .radio-group input[type="radio"]:checked + span{background:var(--accent);border-color:var(--accent);color:white;box-shadow:0 0 8px rgba(31,123,242,.6)}
    details summary{cursor:pointer;margin:8px 0}
    hr{border:none;border-top:1px solid var(--line);margin:24px 0}
    .status{margin-left:10px;font-size:13px;color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn-ghost{background:transparent;border:1px solid #3a4b6a;color:var(--muted)}
    .muted{opacity:.8}
  </style>
</head>
<body>
  <div class="container">
    <h1>OD Image Generator</h1>

    <h2>① Main Header（アニメ / リアル）</h2>
    <select id="selHeader" aria-label="Main Header"></select>
    <div id="headerPrompt" class="prompt-box" aria-live="polite"></div>

    <h2>② Intensity（シチュエーション）</h2>
    <select id="selIntensity" aria-label="Intensity"></select>
    <div id="intensityPrompt" class="prompt-box" aria-live="polite"></div>

    <h2 class="row">③ Emotion（各カテゴリから1つずつ） <span id="emotionCount" class="muted">0 / 0</span></h2>
    <div id="emotionOptions" class="emotion-grid"></div>
    <div id="emotionPrompt" class="prompt-box" aria-live="polite"></div>

    <h2>④ Extra Elements（Eyes / Mouth / Tongue / Saliva / Sweat / Pussy Juice）</h2>
    <div id="extraElements"></div>
    <div id="extraPrompt" class="prompt-box" aria-live="polite"></div>

    <h2>⑤ Custom Prompt (①〜④結合)</h2>
    <div class="row">
      <button id="btnClear135" class="btn-ghost" title="①〜④をリセット">クリア</button>
      <span id="charCount" class="muted">文字数: 0</span>
    </div>
    <textarea id="out" readonly placeholder="ここに結合プロンプトが出力されます"></textarea>
    <button id="btnCopy">コピー</button><span id="statusCustom" class="status"></span>

    <hr>

    <h2>⑥ Outfit（衣装）</h2>
    <select id="selOutfit" aria-label="Outfit"></select>
    <div id="outfitPrompt" class="prompt-box" aria-live="polite"></div>

    <h2>⑦ Accessory（複数選択可）</h2>
    <div class="row">
      <button id="btnToggleAccessory" class="btn-ghost" title="アクセサリ選択UIの切替">選択UI切替</button>
      <span class="muted">（スマホで選びにくい場合は切替）</span>
    </div>
    <select id="selAccessory" multiple aria-label="Accessory"></select>
    <div id="accessoryChecklist" class="row" style="display:none"></div>
    <div id="accessoryPrompt" class="prompt-box" aria-live="polite"></div>

    <h2>⑧ Outfit Prompt (⑥⑦結合)</h2>
    <div class="row">
      <button id="btnClear68" class="btn-ghost">クリア</button>
    </div>
    <textarea id="outfitAccessoryOut" readonly placeholder="ここにOutfit+Accessory結合プロンプトが出力されます"></textarea>
    <button id="btnCopyOutfitAccessory">コピー</button><span id="statusOutfit" class="status"></span>

    <hr>

    <h2>⑨ Negative Prompt</h2>
    <button id="btnCopyNeg">コピー</button><span id="statusNeg" class="status"></span>
    <details>
      <summary>Negative Prompt を表示</summary>
      <textarea id="negPrompt" readonly>(worst quality, low quality:1.4), blurry,
bad anatomy, unrealistic anatomy, malformed body, unnatural body, disfigured,
bad hands, mutated hands, extra digits, missing fingers, fused fingers, long fingers,
bad legs, short legs, stumpy legs,
extra arms, extra legs, missing arms, long neck,
extra body, extra person, multiple people, extra head, extra hand, extra leg, cloned face,
mutated pussy, malformed pussy, fused vagina, extra holes, double vagina, unrealistic pussy,
large areolae, oversized nipples, puffy nipples, stretched nipples,
obese, fat, overweight, flabby, saggy breasts, huge breasts, balloon breasts, gigantic breasts</textarea>
    </details>
  </div>

  <script>
  // ---------- helpers ----------
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));

  const base = "https://ihmn18603-max.github.io/OD-Image-Generator/";
  const urls = {
    header:    base + "Main_Header_v1.0.1.json",
    intensity: base + "Intensity_v1.0.1.json",
    emotion:   base + "Emotion_v1.0.5.json", // ← category を含む生データを利用
    extra:     base + "Extra_elements_v1.0.2.json",
    outfit:    base + "Cloth_v1.0.2.json",
    accessory: base + "Accessory_v1.0.2.json"
  };

  // kind-aware mapping（emotion 以外は toOptions 化）
  function toOptionsByKind(data, kind){
    switch(kind){
      case 'header':    return data.map((r,i)=>({id:i, label:r.label ?? r.Label ?? r.name ?? `Header ${i+1}`,   prompt:r['Header Prompt'] ?? r.prompt ?? r.Prompt ?? ''}));
      case 'intensity': return data.map((r,i)=>({id:i, label:r.label ?? r.Label ?? r.name ?? `Intensity ${i+1}`,prompt:r['Template Prompt'] ?? r.prompt ?? r.Prompt ?? ''}));
      case 'outfit':    return data.map((r,i)=>({id:i, label:r.label ?? r.Label ?? r.name ?? `Outfit ${i+1}`,   prompt:Array.isArray(r['outfit prompt'])? r['outfit prompt'].join(', ') : (r.prompt ?? r.Prompt ?? '')}));
      case 'accessory': return data.map((r,i)=>({id:i, label:r.label ?? r.Label ?? r.name ?? `Accessory ${i+1}`,prompt:r.prompt ?? r.Prompt ?? ''}));
      default:          return data.map((r,i)=>({id:i, label:r.label ?? r.name ?? `Item ${i+1}`,               prompt:r.prompt ?? r.Prompt ?? ''}));
    }
  }

  async function loadJSON(url){
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error(`Fetch失敗: ${url}`);
    return res.json();
  }

  const state = {
    header:[], intensity:[], emotion:[], extra:[], outfit:[], accessory:[],
    sel: { header:null, intensity:null, emotionByCat:{}, extraChoices:{}, extraPrompts:[], outfit:null, accessory:[] }
  };

  function fillSelect(sel, opts, {multi=false, withEmpty=true}={}){
    sel.innerHTML = '';
    if(withEmpty && !multi){
      const none = document.createElement('option');
      none.value = ''; none.textContent = '— 未選択 —'; sel.appendChild(none);
    }
    opts.forEach((o)=>{
      const op = document.createElement('option');
      op.value = String(o.id);
      op.textContent = o.label;
      sel.appendChild(op);
    });
  }

  function build(){
    const parts = [];
    if(state.sel.header)    parts.push(state.sel.header.prompt);
    if(state.sel.intensity) parts.push(state.sel.intensity.prompt);

    // Emotion: カテゴリごとに1つ
    const emoSelected = Object.values(state.sel.emotionByCat).filter(Boolean);
    if(emoSelected.length) parts.push(emoSelected.map(x=>x.prompt).join(', '));

    if(state.sel.extraPrompts?.length) parts.push(state.sel.extraPrompts.join(', '));

    const result = parts.filter(Boolean).join(', ');
    $('#out').value = result;
    $('#charCount').textContent = `文字数: ${result.length}`;

    const wear = [];
    if(state.sel.outfit) wear.push(state.sel.outfit.prompt);
    if(state.sel.accessory?.length) wear.push(state.sel.accessory.map(x=>x.prompt).join(', '));
    $('#outfitAccessoryOut').value = wear.filter(Boolean).join(', ');
  }

  function setStatus(el, msg){ el.textContent = msg; setTimeout(()=> el.textContent = '', 1800); }

  // ---------- init ----------
  async function init(){
    try{
      state.header    = toOptionsByKind(await loadJSON(urls.header),    'header');
      state.intensity = toOptionsByKind(await loadJSON(urls.intensity), 'intensity');
      // Emotion は生配列（category/label/prompt/id 等）を保持
      state.emotion   = await loadJSON(urls.emotion);
      state.extra     = await loadJSON(urls.extra); // category, label, prompt, category level
      state.outfit    = toOptionsByKind(await loadJSON(urls.outfit),    'outfit');
      state.accessory = toOptionsByKind(await loadJSON(urls.accessory), 'accessory');

      fillSelect($('#selHeader'),    state.header);
      fillSelect($('#selIntensity'), state.intensity);
      fillSelect($('#selOutfit'),    state.outfit);
      fillSelect($('#selAccessory'), state.accessory, {multi:true, withEmpty:false});

      // --- Emotion: カテゴリ別ラジオ UI ---
      const emoBox = $('#emotionOptions');
      emoBox.innerHTML = '';

      // グルーピング（小文字カテゴリ）
      const emoGrouped = {};
      state.emotion.forEach(o=>{
        const cat = String(o.category || 'other').toLowerCase();
        (emoGrouped[cat] ||= []).push(o);
      });

      // 表示順（存在するもののみ）
      const emoOrderPref = ['face','smile','stare','special','other'];
      const emoCats = Object.keys(emoGrouped).sort((a,b)=>{
        const ia = emoOrderPref.indexOf(a), ib = emoOrderPref.indexOf(b);
        return (ia===-1?999:ia) - (ib===-1?999:ib) || a.localeCompare(b);
      });

      // カウンタ更新
      function refreshEmotionCounter(){
        const total = emoCats.length;
        const selected = Object.values(state.sel.emotionByCat).filter(Boolean).length;
        $('#emotionCount').textContent = `${selected} / ${total}`;
      }

      // 描画
      emoCats.forEach(cat=>{
        const wrap = document.createElement('div');
        wrap.className = 'radio-group';

        const title = document.createElement('div');
        title.className = 'radio-group__title';
        title.innerHTML = `<strong>${cat}</strong><span class="chip">1つ選択</span>`;
        wrap.appendChild(title);

        // なし
        const noneId = `emo_${cat}__none`;
        const noneInput = document.createElement('input');
        noneInput.type = 'radio'; noneInput.name = `emo_${cat}`; noneInput.id = noneId; noneInput.value = '';
        noneInput.onchange = ()=>{
          delete state.sel.emotionByCat[cat];
          $('#emotionPrompt').textContent = Object.values(state.sel.emotionByCat)
            .filter(Boolean).map(x=>x.prompt).join(', ');
          refreshEmotionCounter();
          build();
        };
        const noneLabel = document.createElement('label');
        noneLabel.setAttribute('for', noneId);
        const noneSpan = document.createElement('span');
        noneSpan.textContent = 'なし';
        noneLabel.appendChild(noneInput); noneLabel.appendChild(noneSpan);
        wrap.appendChild(noneLabel);

        // 選択肢
        emoGrouped[cat].forEach((opt, idx)=>{
          const id = `emo_${cat}__${idx}`;
          const radio = document.createElement('input');
          radio.type = 'radio'; radio.name = `emo_${cat}`; radio.id = id; radio.value = opt.id ?? idx;
          radio.onchange = ()=>{
            state.sel.emotionByCat[cat] = opt;
            $('#emotionPrompt').textContent = Object.values(state.sel.emotionByCat)
              .filter(Boolean).map(x=>x.prompt).join(', ');
            refreshEmotionCounter();
            build();
          };

          const label = document.createElement('label');
          label.setAttribute('for', id);
          const span = document.createElement('span');
          span.textContent = opt.label || opt.tag || opt.prompt || `Option ${idx+1}`;
          label.appendChild(radio); label.appendChild(span);

          wrap.appendChild(label);
        });

        emoBox.appendChild(wrap);
      });

      // 初期カウンタ
      refreshEmotionCounter();

      // ------- Extra Elements: ラジオ UI -------
      const container = $('#extraElements');
      container.innerHTML = '';
      const grouped = {};
      state.extra.forEach(item=>{
        const cat = item.category || 'Other';
        (grouped[cat] ||= []).push(item);
      });

      const preferredOrder = ['eye','mouth','tongue','saliva','sweat','pussy juice','Other'];
      const keys = Object.keys(grouped).sort((a,b)=>{
        const ia = preferredOrder.indexOf(String(a).toLowerCase());
        const ib = preferredOrder.indexOf(String(b).toLowerCase());
        return (ia===-1?999:ia) - (ib===-1?999:ib) || a.localeCompare(b);
      });
      keys.forEach(cat=>{
        const wrap = document.createElement('div');
        wrap.className = 'radio-group';
        const title = document.createElement('div');
        title.className = 'radio-group__title';
        title.innerHTML = `<strong>${cat}</strong><span class="chip">1つ選択</span>`;
        wrap.appendChild(title);

        // none option
        const noneId = `${cat}__none`;
        const noneInput = document.createElement('input');
        noneInput.type = 'radio'; noneInput.name = cat; noneInput.id = noneId; noneInput.value = '';
        noneInput.onchange = ()=>{
          delete state.sel.extraChoices[cat];
          state.sel.extraPrompts = Object.values(state.sel.extraChoices).filter(Boolean);
          $('#extraPrompt').textContent = state.sel.extraPrompts.join(', ');
          build();
        };
        const noneLabel = document.createElement('label');
        noneLabel.setAttribute('for', noneId);
        const noneSpan = document.createElement('span');
        noneSpan.textContent = 'なし';
        noneLabel.appendChild(noneInput); noneLabel.appendChild(noneSpan);
        wrap.appendChild(noneLabel);

        grouped[cat].forEach((opt, idx)=>{
          const id = `${cat}__${idx}`; // 安全な一意ID
          const radio = document.createElement('input');
          radio.type = 'radio'; radio.name = cat; radio.id = id; radio.value = opt.prompt || '';
          radio.onchange = ()=>{
            state.sel.extraChoices[cat] = radio.value;
            state.sel.extraPrompts = Object.values(state.sel.extraChoices).filter(Boolean);
            $('#extraPrompt').textContent = state.sel.extraPrompts.join(', ');
            build();
          };
          const label = document.createElement('label');
          label.setAttribute('for', id);
          const span = document.createElement('span');
          span.textContent = opt.label || `Lv ${opt['category level'] ?? idx+1}`;
          label.appendChild(radio); label.appendChild(span);
          wrap.appendChild(label);
        });
        container.appendChild(wrap);
      });

    }catch(err){
      console.error(err);
      alert('データ読み込みに失敗しました。GitHubのJSONパスとCORS/公開設定を確認してください。\n\n' + err.message);
    }
  }

  // ---------- events ----------
  $('#selHeader').addEventListener('change', (e)=>{
    const id = e.target.value; state.sel.header = state.header.find(x=> String(x.id)===id) || null;
    $('#headerPrompt').textContent = state.sel.header?.prompt || '';
    build();
  });
  $('#selIntensity').addEventListener('change', (e)=>{
    const id = e.target.value; state.sel.intensity = state.intensity.find(x=> String(x.id)===id) || null;
    $('#intensityPrompt').textContent = state.sel.intensity?.prompt || '';
    build();
  });
  $('#selOutfit').addEventListener('change', (e)=>{
    const id = e.target.value; state.sel.outfit = state.outfit.find(x=> String(x.id)===id) || null;
    $('#outfitPrompt').textContent = state.sel.outfit?.prompt || '';
    build();
  });
  $('#selAccessory').addEventListener('change', (e)=>{
    const ids = Array.from(e.target.selectedOptions).map(o=> o.value);
    state.sel.accessory = ids.map(id=> state.accessory.find(x=> String(x.id)===id)).filter(Boolean);
    $('#accessoryPrompt').textContent = state.sel.accessory.map(x=>x.prompt).join(', ');
    build();
  });

  $('#btnCopy').addEventListener('click', async()=>{
    try{ await navigator.clipboard.writeText($('#out').value); setStatus($('#statusCustom'), 'コピーしました！'); }
    catch{ setStatus($('#statusCustom'), 'コピー失敗'); }
  });
  $('#btnCopyOutfitAccessory').addEventListener('click', async()=>{
    try{ await navigator.clipboard.writeText($('#outfitAccessoryOut').value); setStatus($('#statusOutfit'), 'Outfit Promptをコピーしました！'); }
    catch{ setStatus($('#statusOutfit'), 'コピー失敗'); }
  });
  $('#btnCopyNeg').addEventListener('click', async()=>{
    try{ await navigator.clipboard.writeText($('#negPrompt').value); setStatus($('#statusNeg'), 'Negative Promptをコピーしました！'); }
    catch{ setStatus($('#statusNeg'), 'コピー失敗'); }
  });

  // Clear buttons
  $('#btnClear135').addEventListener('click', ()=>{
    $('#selHeader').value = ''; state.sel.header = null; $('#headerPrompt').textContent = '';
    $('#selIntensity').value = ''; state.sel.intensity = null; $('#intensityPrompt').textContent = '';

    // Emotion: 全カテゴリ未選択へ
    state.sel.emotionByCat = {};
    $$('#emotionOptions input[type="radio"]').forEach(r=> r.checked = false);
    $('#emotionPrompt').textContent = '';
    (function(){
      const groups = new Set($$('#emotionOptions input[type="radio"]').map(r=>r.name));
      $('#emotionCount').textContent = `0 / ${groups.size || 0}`;
    })();

    Object.keys(state.sel.extraChoices).forEach(k=> delete state.sel.extraChoices[k]);
    state.sel.extraPrompts = []; $('#extraPrompt').textContent = '';
    build();
  });
  $('#btnClear68').addEventListener('click', ()=>{
    $('#selOutfit').value = ''; state.sel.outfit = null; $('#outfitPrompt').textContent = '';
    $('#selAccessory').value = null; state.sel.accessory = []; $('#accessoryPrompt').textContent = '';
    // checklist側も全部オフ
    $$('#accessoryChecklist input[type="checkbox"]').forEach(ch=> ch.checked = false);
    build();
  });

  // Accessory: checklist UI for smartphone
  $('#btnToggleAccessory').addEventListener('click', ()=>{
    const list = $('#accessoryChecklist');
    const sel  = $('#selAccessory');
    if(list.style.display === 'none' || list.style.display === ''){
      // build checklist from current data
      list.innerHTML = '';
      state.accessory.forEach(it=>{
        const id = `acc__${it.id}`;
        const wrap = document.createElement('label');
        wrap.className = 'chip';
        wrap.setAttribute('for', id);
        const cb = document.createElement('input');
        cb.type = 'checkbox'; cb.id = id; cb.value = String(it.id); cb.style.display='none';
        const span = document.createElement('span'); span.textContent = it.label;
        // reflect current selection
        cb.checked = !!state.sel.accessory.find(a=> String(a.id)===String(it.id));
        cb.onchange = ()=>{
          if(cb.checked){ sel.querySelector(`option[value="${it.id}"]`).selected = true; }
          else { sel.querySelector(`option[value="${it.id}"]`).selected = false; }
          const event = new Event('change', {bubbles:true}); sel.dispatchEvent(event);
        };
        wrap.appendChild(cb); wrap.appendChild(span);
        list.appendChild(wrap);
      });
      list.style.display = 'flex'; sel.style.display = 'none';
    }else{
      list.style.display = 'none'; sel.style.display = 'block';
    }
  });

  init();
  </script>
</body>
</html>
