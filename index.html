<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OD Model Generator</title>
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: sans-serif;
      padding: 10px;
      max-width: 700px;
      margin: auto;
    }
    select, textarea, button, input {
      font-size: 14px;
    }
    select, input {
      margin: 10px 0;
      padding: 6px;
      background-color: #111;
      color: #fff;
      border: 1px solid #444;
      width: 100%;
      box-sizing: border-box;
    }
    .accordion {
      margin-bottom: 10px;
      border: 1px solid #444;
      border-radius: 6px;
      overflow: hidden;
    }
    .accordion-header {
      background-color: #222;
      padding: 12px;
      cursor: pointer;
      font-weight: bold;
    }
    .accordion-header:hover {
      background-color: #333;
    }
    .accordion-content {
      display: none;
      padding: 10px;
      background-color: #111;
    }
    .prompt-block {
      margin-bottom: 20px;
      padding: 10px;
    }
    textarea {
      width: 100%;
      height: 80px;
      padding: 8px;
      margin-top: 5px;
      background-color: #222;
      color: #fff;
      border: 1px solid #555;
      box-sizing: border-box;
      font-size: 14px;
    }
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .button-group button {
      flex: 1;
      padding: 10px;
      cursor: pointer;
      background-color: #333;
      color: #fff;
      border: 1px solid #666;
      border-radius: 4px;
      text-align: center;
    }
    .button-group button:hover {
      background-color: #444;
    }
  </style>
</head>
<body>
  <h1>🌍 OD Model Generator</h1>

  <!-- 国籍 -->
  <div class="accordion">
    <div class="accordion-header">🌍 Nationality</div>
    <div class="accordion-content" style="display:block;">
      <div id="prompt-container">国コードを選択してください。</div>
    </div>
  </div>

  <!-- Fetish -->
  <div class="accordion">
    <div class="accordion-header">🔞 Fetish</div>
    <div class="accordion-content">
      <div id="fetish-container">カテゴリを選択してください。</div>
    </div>
  </div>

  <!-- Other -->
  <div class="accordion">
    <div class="accordion-header">🌀 Other</div>
    <div class="accordion-content">
      <div id="other-container">タイプを選択してください。</div>
    </div>
  </div>

  <script>
    // --- Accordion toggle (一つだけ開ける方式) ---
    document.querySelectorAll(".accordion-header").forEach(header => {
      header.addEventListener("click", () => {
        document.querySelectorAll(".accordion-content").forEach(c => c.style.display = "none");
        const content = header.nextElementSibling;
        content.style.display = "block";
      });
    });

    async function loadJSON(url) {
      const response = await fetch(url);
      if (!response.ok) throw new Error("Failed to load JSON");
      return await response.json();
    }

    // --- Nationality ---
    function renderPrompts(data, selectedCode = "") {
      const container = document.getElementById("prompt-container");
      container.innerHTML = "";

      const select = document.createElement("select");
      select.innerHTML = `<option value="">国コードを選択してください</option>`;
      const codes = [...new Set(data.map(entry => entry.code))];
      codes.forEach(code => {
        const option = document.createElement("option");
        option.value = code;
        option.textContent = code;
        select.appendChild(option);
      });
      container.appendChild(select);

      const resultDiv = document.createElement("div");
      container.appendChild(resultDiv);

      select.addEventListener("change", () => {
        resultDiv.innerHTML = "";
        const entry = data.find(e => e.code === select.value);
        if (!entry) return;

        // 基本情報
        const info = document.createElement("p");
        info.innerHTML = `
          <strong>国名:</strong> ${entry.label || ""}<br>
          <strong>Base Aura:</strong> ${entry["base_aura"] || ""}<br>
          <strong>Base Skin:</strong> ${entry["base_skin"] || ""}<br>
          <strong>Figure Structure:</strong> ${entry["figure_structure"] || ""}<br>
          <strong>Face Structure:</strong> ${entry["face_structure"] || ""}<br>
          <strong>Notes:</strong> ${entry["notes"] || ""}<br>
        `;
        resultDiv.appendChild(info);

        // Personality / Physical / Facial
        ["Personality","Physical Prompt","Facial Prompt"].forEach(key => {
          const label = document.createElement("strong");
          label.textContent = key.replace(" Prompt",""); 
          resultDiv.appendChild(label);

          const ta = document.createElement("textarea");
          ta.readOnly = true;
          ta.textContent = entry[key] || "";
          resultDiv.appendChild(ta);

          const btnGroup = document.createElement("div");
          btnGroup.className = "button-group";
          const btn = document.createElement("button");
          btn.textContent = `Copy ${label.textContent}`;
          btn.onclick = () => {
            navigator.clipboard.writeText(ta.value)
              .then(() => alert(`✅ ${label.textContent} をコピーしました！`))
              .catch(() => alert("⚠️ コピーに失敗しました"));
          };
          btnGroup.appendChild(btn);
          resultDiv.appendChild(btnGroup);
        });
      });
    }
    loadJSON("ODnationality_v1.0.0.json").then(data => renderPrompts(data));

    // --- Fetish ---
    async function loadFetish(url) {
      const data = await loadJSON(url);
      const container = document.getElementById("fetish-container");

      // 選択状態を保存する Set
      const selectedPrompts = new Set();

      // --- Category セレクト ---
      const categories = [...new Set(data.map(e => e.category))];
      const catSelect = document.createElement("select");
      catSelect.innerHTML = `<option value="">カテゴリを選択</option>`;
      categories.forEach(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        catSelect.appendChild(option);
      });
      container.appendChild(catSelect);

      const listDiv = document.createElement("div");
      container.appendChild(listDiv);

      // --- 最大選択数入力 & 選択数表示 ---
      const settingsDiv = document.createElement("div");
      settingsDiv.style.margin = "10px 0";

      const maxLabel = document.createElement("label");
      maxLabel.textContent = "最大選択数: ";
      const maxInput = document.createElement("input");
      maxInput.type = "number";
      maxInput.value = 5;
      maxInput.min = 1;
      maxInput.style.width = "80px";

      const countDisplay = document.createElement("span");
      countDisplay.style.marginLeft = "10px";
      countDisplay.textContent = `選択中: 0 / ${maxInput.value}`;

      settingsDiv.appendChild(maxLabel);
      settingsDiv.appendChild(maxInput);
      settingsDiv.appendChild(countDisplay);

      container.appendChild(settingsDiv);

      // --- 出力エリア & ボタン ---
      const resultArea = document.createElement("textarea");
      resultArea.readOnly = true;
      container.appendChild(resultArea);

      const copyBtn = document.createElement("button");
      copyBtn.textContent = "Copy Fetish Prompts";
      container.appendChild(copyBtn);

      // --- 選択数更新関数 ---
      function updateCountDisplay() {
        const MAX_FETISH = parseInt(maxInput.value, 10) || 5;
        countDisplay.textContent = `選択中: ${selectedPrompts.size} / ${MAX_FETISH}`;
      }

      // --- リスト描画関数 ---
      function renderList(category) {
        listDiv.innerHTML = "";
        const filtered = category ? data.filter(e => e.category === category) : data;

        filtered.forEach(entry => {
          const label = document.createElement("label");
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.value = entry.prompt;
          cb.checked = selectedPrompts.has(entry.prompt);

          cb.onchange = () => {
            const MAX_FETISH = parseInt(maxInput.value, 10) || 5;
            if (cb.checked) {
              if (selectedPrompts.size >= MAX_FETISH) {
                cb.checked = false;
                alert(`⚠️ 選択は最大 ${MAX_FETISH} 個までです`);
                return;
              }
              selectedPrompts.add(entry.prompt);
            } else {
              selectedPrompts.delete(entry.prompt);
            }
            updateCountDisplay();
          };

          label.appendChild(cb);
          label.appendChild(document.createTextNode(`${entry.label}`));
          listDiv.appendChild(label);
          listDiv.appendChild(document.createElement("br"));
        });
      }

      // 初期表示（全カテゴリ）
      renderList("");
      updateCountDisplay();

      // カテゴリ切り替え
      catSelect.addEventListener("change", () => {
        renderList(catSelect.value);
      });

      // 最大選択数変更時に更新
      maxInput.addEventListener("input", updateCountDisplay);

      // コピー
      copyBtn.onclick = () => {
        const prompts = Array.from(selectedPrompts).join(", ");
        resultArea.value = prompts;
        navigator.clipboard.writeText(prompts)
          .then(() => alert("✅ Fetish prompts をコピーしました！"))
          .catch(() => alert("⚠️ コピーに失敗しました"));
      };
    }
    loadFetish("Fetish_v1.0.1.json");

    // --- Other ---
    async function loadOther(url) {
      const data = await loadJSON(url);
      const container = document.getElementById("other-container");

      const select = document.createElement("select");
      select.innerHTML = `<option value="">タイプを選択</option>`;
      data.forEach(entry => {
        const option = document.createElement("option");
        option.value = entry["タイプ"];
        option.textContent = entry["タイプ"];
        select.appendChild(option);
      });
      container.appendChild(select);

      const detailsArea = document.createElement("textarea");
      detailsArea.placeholder = "Additional Personality Details";
      detailsArea.readOnly = true;
      container.appendChild(detailsArea);

      const scenarioArea = document.createElement("textarea");
      scenarioArea.placeholder = "Scenario";
      scenarioArea.readOnly = true;
      container.appendChild(scenarioArea);

      const btnGroup = document.createElement("div");
      btnGroup.className = "button-group";
      container.appendChild(btnGroup);

      const copyDetails = document.createElement("button");
      copyDetails.textContent = "Copy Details";
      btnGroup.appendChild(copyDetails);

      const copyScenario = document.createElement("button");
      copyScenario.textContent = "Copy Scenario";
      btnGroup.appendChild(copyScenario);

      select.addEventListener("change", () => {
        const entry = data.find(e => e["タイプ"] === select.value);
        detailsArea.value = entry ? entry["Additional Personality Details"] : "";
        scenarioArea.value = entry ? entry["Scenario"] : "";
      });

      copyDetails.onclick = () => navigator.clipboard.writeText(detailsArea.value)
        .then(() => alert("✅ Details をコピーしました！"))
        .catch(() => alert("⚠️ コピーに失敗しました"));

      copyScenario.onclick = () => navigator.clipboard.writeText(scenarioArea.value)
        .then(() => alert("✅ Scenario をコピーしました！"))
        .catch(() => alert("⚠️ コピーに失敗しました"));
    }
    loadOther("Other_v1.0.0.json");
  </script>
</body>
</html>
